<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>خريطة المزرعة — عرض وتعديل KML/GeoJSON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <style>
    body { margin:0; font-family: Arial, sans-serif; direction: rtl; }
    #topbar { padding:10px; background:#f7f7f7; border-bottom:1px solid #ddd; display:flex; gap:10px; align-items:center; }
    #map { height: calc(100vh - 58px); }
    .btn { padding:6px 10px; background:#2E86AB; color:white; border:none; cursor:pointer; border-radius:4px; }
    .btn.gray { background:#6c757d; }
    input[type=file] { display:inline-block; }
    #status { margin-left:12px;color:#333 }
  </style>
</head>
<body>
  <div id="topbar">
    <div>
      <label for="fileInput">تحميل ملف KML/GeoJSON (اختياري):</label>
      <input id="fileInput" type="file" accept=".kml,.geojson,.json"/>
    </div>
    <button id="downloadGeojson" class="btn gray">تنزيل GeoJSON</button>
    <button id="saveServer" class="btn">حفظ تلقائي (إذا مفعّل)</button>
    <button id="zoomAll" class="btn">تكبير لعرض الكل</button>
    <div id="status">جارٍ التحميل...</div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/togeojson@0.16.0/dist/togeojson.js"></script>

  <script>
    const status = document.getElementById('status');

    const map = L.map('map').setView([30.74, 30.14], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 22, attribution: '© OpenStreetMap'
    }).addTo(map);

    const drawnItems = new L.FeatureGroup().addTo(map);

    const drawControl = new L.Control.Draw({
      edit: { featureGroup: drawnItems },
      draw: {
        polygon: true,
        rectangle: true,
        polyline: false,
        circle: false,
        marker: false,
        circlemarker: false
      }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (e) {
      drawnItems.addLayer(e.layer);
    });

    function bindFeaturePopup(layer, properties) {
      let html = '';
      if (properties && Object.keys(properties).length) {
        html += '<div>';
        for (const k in properties) {
          html += `<b>${k}:</b> ${properties[k]}<br/>`;
        }
        html += '</div>';
      } else {
        html = '<div>لا توجد خصائص</div>';
      }
      layer.bindPopup(html);
    }

    // Helper: create Leaflet icon from feature.properties.icon (data: or url)
    function createIconFromProps(props) {
      if (!props) return null;
      const iconUrl = props.icon || props['icon-url'] || props.image;
      if (!iconUrl) return null;
      // determine size from icon-scale (fallback 32)
      const scale = parseFloat(props['icon-scale'] || props['icon-scale'] === 0 ? props['icon-scale'] : (props['icon-scale'] || 1));
      const baseSize = 32;
      const size = Math.max(12, Math.round(baseSize * (scale || 1)));
      return L.icon({
        iconUrl: iconUrl,
        iconSize: [size, size],
        iconAnchor: [Math.round(size/2), size],
        popupAnchor: [0, -size/2]
      });
    }

    function addGeoJSONToMap(geojson) {
      drawnItems.clearLayers();
      L.geoJSON(geojson, {
        // style for Polygons/Lines using properties if present
        style: function(feature) {
          const p = feature.properties || {};
          return {
            color: p.stroke || p['stroke'] || '#2E86AB',
            weight: p['stroke-width'] || p['stroke_width'] || p['strokeWidth'] || 2,
            opacity: (p['stroke-opacity'] !== undefined) ? p['stroke-opacity'] : (p['stroke_opacity'] !== undefined ? p['stroke_opacity'] : 1),
            fillColor: p.fill || p['fill'] || '#ffffff',
            fillOpacity: (p['fill-opacity'] !== undefined) ? p['fill-opacity'] : (p['fill_opacity'] !== undefined ? p['fill_opacity'] : 0.35)
          };
        },
        pointToLayer: function(feature, latlng) {
          // If icon property exists, use it; otherwise circleMarker
          const p = feature.properties || {};
          const icon = createIconFromProps(p);
          if (icon) {
            return L.marker(latlng, { icon: icon });
          } else {
            // allow customization of point radius by property
            const r = p['marker-radius'] || p['radius'] || 6;
            return L.circleMarker(latlng, { radius: r, color: p.stroke || '#2E86AB', fillColor: p.fill || '#2E86AB', fillOpacity: 0.9 });
          }
        },
        onEachFeature: function(feature, layer) {
          bindFeaturePopup(layer, feature.properties || {});
          drawnItems.addLayer(layer);
        }
      }).addTo(map);

      if (drawnItems.getLayers().length) {
        try {
          map.fitBounds(drawnItems.getBounds(), { padding:[20,20] });
        } catch(e) {
          console.warn('fitBounds failed:', e);
        }
      }
      status.textContent = 'تم العرض — يمكنك التعديل ثم الحفظ أو التنزيل';
    }

    // --- تحميل افتراضي الآن من ملف GeoJSON (map-3.geojson) إذا موجود ---
    fetch('map-3.geojson')
      .then(r => {
        if (!r.ok) throw new Error('لا يوجد ملف GeoJSON افتراضي');
        return r.json();
      })
      .then(geo => {
        addGeoJSONToMap(geo);
      })
      .catch(err => {
        // إن لم نجد GeoJSON سنبقي رسالة للمستخدم ونبقي خيار رفع KML/GeoJSON يدوياً
        status.textContent = 'لم يتم العثور على ملف افتراضي (map-3.geojson). يمكنك تحميل KML أو GeoJSON يدوياً.';
        console.log(err);
      });

    // تحميل KML أو GeoJSON من الملف المحلي للمستخدم
    document.getElementById('fileInput').addEventListener('change', function(evt) {
      const file = evt.target.files[0];
      if (!file) return;
      status.textContent = 'جارٍ قراءة الملف...';
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          if (file.name.toLowerCase().endsWith('.kml')) {
            const parser = new DOMParser();
            const kmlDoc = parser.parseFromString(text, 'text/xml');
            const geojson = toGeoJSON.kml(kmlDoc);
            addGeoJSONToMap(geojson);
          } else {
            // نفترض GeoJSON/JSON
            const geo = JSON.parse(text);
            addGeoJSONToMap(geo);
          }
          status.textContent = 'تم تحميل الملف وعرضه.';
        } catch (err) {
          console.error(err);
          alert('حدث خطأ أثناء تحويل/قراءة الملف. تأكد من صحة الملف.');
          status.textContent = 'خطأ في قراءة الملف';
        }
      };
      reader.readAsText(file);
    });

    // تنزيل GeoJSON
    document.getElementById('downloadGeojson').addEventListener('click', function() {
      const allGeojson = drawnItems.toGeoJSON();
      const str = JSON.stringify(allGeojson, null, 2);
      const blob = new Blob([str], {type: "application/json;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'plots.geojson';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    document.getElementById('zoomAll').addEventListener('click', function(){
      if (drawnItems.getLayers().length) {
        map.fitBounds(drawnItems.getBounds(), { padding:[20,20] });
      } else {
        alert('لا توجد طبقات للعرض.');
      }
    });

    // حفظ تلقائي عبر Netlify Function (أو أي عنوان وظيفة لديك)
    document.getElementById('saveServer').addEventListener('click', async function(){
      // نجهز GeoJSON
      const geo = drawnItems.toGeoJSON();
      if (!geo.features || !geo.features.length) {
        alert('لا توجد طبعات لحفظها.');
        return;
      }

      const adminSecret = prompt('ادخل سر الأدمن (ADMIN_SECRET) لتأكيد الحفظ التلقائي (سيُطلب منك مرة لكل حفظ):');
      if (!adminSecret) return;

      try {
        status.textContent = 'جارٍ إرسال البيانات للحفظ...';
        const res = await fetch('/.netlify/functions/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            admin_secret: adminSecret,
            commit_message: 'تحديث قطع المزرعة (حفظ من الواجهة)',
            path: 'data/plots.geojson',
            content: geo
          })
        });
        const j = await res.json();
        if (res.ok) {
          alert('تم الحفظ بنجاح: ' + (j.message || 'تم'));
          status.textContent = 'تم الحفظ على الخادم';
        } else {
          alert('خطأ في الحفظ: ' + (j.error || JSON.stringify(j)));
          status.textContent = 'خطأ في الحفظ';
        }
      } catch (err) {
        console.error(err);
        alert('حدث خطأ أثناء الاتصال بالخادم. تأكد من إعداد Netlify Function.');
        status.textContent = 'خطأ في الاتصال';
      }
    });

  </script>
  // --- إضافة زر تفاعلي لإدراج علامة المزرعة ---
const placeMarkerBtn = L.control({ position: 'topleft' });
placeMarkerBtn.onAdd = function(map) {
  const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
  div.style.background = '#2E86AB';
  div.style.color = 'white';
  div.style.padding = '6px';
  div.style.cursor = 'pointer';
  div.title = 'أضف علامة المزرعة';
  div.innerHTML = 'أضف علامة';
  L.DomEvent.on(div, 'click', function(e) {
    L.DomEvent.stopPropagation(e);
    const name = prompt('اكتب اسم المزرعة:', 'مزرعتي');
    if (!name) return;
    alert('الآن اضغط على المكان في الخريطة لوضع العلامة.');
    map.once('click', function(ev) {
      addFarmMarker(ev.latlng.lat, ev.latlng.lng, name);
    });
  });
  return div;
};
placeMarkerBtn.addTo(map);

// دالة إضافة العلامة وحفظها في drawnItems
function addFarmMarker(lat, lng, name) {
  const marker = L.marker([lat, lng], { riseOnHover: true });
  marker.feature = {
    type: 'Feature',
    geometry: { type: 'Point', coordinates: [lng, lat] },
    properties: { name: name }
  };
  marker.bindPopup(`<b>${name}</b>`);
  drawnItems.addLayer(marker);
  marker.openPopup();
  map.setView([lat, lng], 16);
}
</body>
</html>
